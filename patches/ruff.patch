From c4c685c9b4c42f94b04e2af7167b3daae34da145 Mon Sep 17 00:00:00 2001
From: SkyBird <52884766+SkyBird233@users.noreply.github.com>
Date: Sat, 13 Sep 2025 01:49:13 +0800
Subject: [PATCH] [ruff]: Build loongarch64 binaries in CI

---
 .github/workflows/build-binaries.yml       | 12 ++++++++++--
 .github/workflows/publish-pypi.yml         |  2 ++
 crates/ruff/Cargo.toml                     |  2 +-
 crates/ruff/src/main.rs                    |  3 ++-
 crates/ruff_benchmark/Cargo.toml           |  2 +-
 crates/ruff_benchmark/benches/formatter.rs |  3 ++-
 crates/ruff_benchmark/benches/lexer.rs     |  3 ++-
 crates/ruff_benchmark/benches/linter.rs    |  6 ++++--
 crates/ruff_benchmark/benches/parser.rs    |  3 ++-
 dist-workspace.toml                        |  1 +
 10 files changed, 27 insertions(+), 10 deletions(-)

diff --git a/.github/workflows/build-binaries.yml b/.github/workflows/build-binaries.yml
index 7ae4d244eb..57aa25ad75 100644
--- a/.github/workflows/build-binaries.yml
+++ b/.github/workflows/build-binaries.yml
@@ -299,6 +299,11 @@ jobs:
             arch: arm
           - target: riscv64gc-unknown-linux-gnu
             arch: riscv64
+          - target: loongarch64-unknown-linux-gnu
+            arch: loong64
+            # There's currently no loong64 support for Ubuntu so we are using Debian
+            base_image: --platform=linux/loong64 ghcr.io/loong64/debian:trixie
+            maturin_docker_options: -e JEMALLOC_SYS_WITH_LG_PAGE=16
 
     steps:
       - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
@@ -324,12 +329,15 @@ jobs:
         with:
           arch: ${{ matrix.platform.arch == 'arm' && 'armv6' || matrix.platform.arch }}
           distro: ${{ matrix.platform.arch == 'arm' && 'bullseye' || 'ubuntu20.04' }}
+          base_image: ${{ matrix.platform.base_image }}
           githubToken: ${{ github.token }}
           install: |
             apt-get update
-            apt-get install -y --no-install-recommends python3 python3-pip libatomic1
-            pip3 install -U pip
+            apt-get install -y --no-install-recommends python3 python3-pip python3-venv libatomic1
           run: |
+            python3 -m venv .venv
+            source .venv/bin/activate
+            pip3 install -U pip
             pip3 install ${{ env.PACKAGE_NAME }} --no-index --find-links dist/ --force-reinstall
             ruff --help
       - name: "Upload wheels"
diff --git a/.github/workflows/publish-pypi.yml b/.github/workflows/publish-pypi.yml
index 5719a1d797..d2fbcbf916 100644
--- a/.github/workflows/publish-pypi.yml
+++ b/.github/workflows/publish-pypi.yml
@@ -28,5 +28,7 @@ jobs:
           pattern: wheels-*
           path: wheels
           merge-multiple: true
+      - name: Remove wheels unsupported by PyPI
+        run: rm wheels/*loong*
       - name: Publish to PyPi
         run: uv publish -v wheels/*
diff --git a/crates/ruff/Cargo.toml b/crates/ruff/Cargo.toml
index 547ddf5fa9..a5bd1a74f2 100644
--- a/crates/ruff/Cargo.toml
+++ b/crates/ruff/Cargo.toml
@@ -69,7 +69,7 @@ tracing = { workspace = true, features = ["log"] }
 walkdir = { workspace = true }
 wild = { workspace = true }
 
-[target.'cfg(all(not(target_os = "windows"), not(target_os = "openbsd"), not(target_os = "aix"), not(target_os = "android"), any(target_arch = "x86_64", target_arch = "aarch64", target_arch = "powerpc64", target_arch = "riscv64")))'.dependencies]
+[target.'cfg(all(not(target_os = "windows"), not(target_os = "openbsd"), not(target_os = "aix"), not(target_os = "android"), any(target_arch = "x86_64", target_arch = "aarch64", target_arch = "powerpc64", target_arch = "riscv64", target_arch = "loongarch64")))'.dependencies]
 tikv-jemallocator = { workspace = true }
 
 [target.'cfg(target_os = "windows")'.dependencies]
diff --git a/crates/ruff/src/main.rs b/crates/ruff/src/main.rs
index 5ec78c9e25..25387eb531 100644
--- a/crates/ruff/src/main.rs
+++ b/crates/ruff/src/main.rs
@@ -21,7 +21,8 @@ static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
         target_arch = "x86_64",
         target_arch = "aarch64",
         target_arch = "powerpc64",
-        target_arch = "riscv64"
+        target_arch = "riscv64",
+        target_arch = "loongarch64",
     )
 ))]
 #[global_allocator]
diff --git a/crates/ruff_benchmark/Cargo.toml b/crates/ruff_benchmark/Cargo.toml
index 760aed7b1e..2450149d1d 100644
--- a/crates/ruff_benchmark/Cargo.toml
+++ b/crates/ruff_benchmark/Cargo.toml
@@ -33,7 +33,7 @@ serde = { workspace = true }
 serde_json = { workspace = true }
 tracing = { workspace = true }
 
-[target.'cfg(all(not(target_os = "windows"), not(target_os = "openbsd"), any(target_arch = "x86_64", target_arch = "aarch64", target_arch = "powerpc64", target_arch = "riscv64")))'.dependencies]
+[target.'cfg(all(not(target_os = "windows"), not(target_os = "openbsd"), any(target_arch = "x86_64", target_arch = "aarch64", target_arch = "powerpc64", target_arch = "riscv64", target_arch = "loongarch64")))'.dependencies]
 tikv-jemallocator = { workspace = true, optional = true }
 
 [target.'cfg(target_os = "windows")'.dependencies]
diff --git a/crates/ruff_benchmark/benches/formatter.rs b/crates/ruff_benchmark/benches/formatter.rs
index f2bd54bb44..a2c56c175e 100644
--- a/crates/ruff_benchmark/benches/formatter.rs
+++ b/crates/ruff_benchmark/benches/formatter.rs
@@ -22,7 +22,8 @@ static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
         target_arch = "x86_64",
         target_arch = "aarch64",
         target_arch = "powerpc64",
-        target_arch = "riscv64"
+        target_arch = "riscv64",
+        target_arch = "loongarch64"
     )
 ))]
 #[global_allocator]
diff --git a/crates/ruff_benchmark/benches/lexer.rs b/crates/ruff_benchmark/benches/lexer.rs
index 3b1a4dafde..ab7217e376 100644
--- a/crates/ruff_benchmark/benches/lexer.rs
+++ b/crates/ruff_benchmark/benches/lexer.rs
@@ -20,7 +20,8 @@ static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
         target_arch = "x86_64",
         target_arch = "aarch64",
         target_arch = "powerpc64",
-        target_arch = "riscv64"
+        target_arch = "riscv64",
+        target_arch = "loongarch64"
     )
 ))]
 #[global_allocator]
diff --git a/crates/ruff_benchmark/benches/linter.rs b/crates/ruff_benchmark/benches/linter.rs
index 98ef4083a9..4c1eb8b69e 100644
--- a/crates/ruff_benchmark/benches/linter.rs
+++ b/crates/ruff_benchmark/benches/linter.rs
@@ -27,7 +27,8 @@ static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
         target_arch = "x86_64",
         target_arch = "aarch64",
         target_arch = "powerpc64",
-        target_arch = "riscv64"
+        target_arch = "riscv64",
+        target_arch = "loongarch64"
     )
 ))]
 #[global_allocator]
@@ -44,7 +45,8 @@ static GLOBAL: tikv_jemallocator::Jemalloc = tikv_jemallocator::Jemalloc;
         target_arch = "x86_64",
         target_arch = "aarch64",
         target_arch = "powerpc64",
-        target_arch = "riscv64"
+        target_arch = "riscv64",
+        target_arch = "loongarch64"
     )
 ))]
 #[unsafe(export_name = "_rjem_malloc_conf")]
diff --git a/crates/ruff_benchmark/benches/parser.rs b/crates/ruff_benchmark/benches/parser.rs
index d5e086eb50..d1bbe6fd9f 100644
--- a/crates/ruff_benchmark/benches/parser.rs
+++ b/crates/ruff_benchmark/benches/parser.rs
@@ -21,7 +21,8 @@ static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
         target_arch = "x86_64",
         target_arch = "aarch64",
         target_arch = "powerpc64",
-        target_arch = "riscv64"
+        target_arch = "riscv64",
+        target_arch = "loongarch64"
     )
 ))]
 #[global_allocator]
diff --git a/dist-workspace.toml b/dist-workspace.toml
index 002337b47e..0337e63185 100644
--- a/dist-workspace.toml
+++ b/dist-workspace.toml
@@ -30,6 +30,7 @@ targets = [
     "powerpc64le-unknown-linux-gnu",
     "riscv64gc-unknown-linux-gnu",
     "s390x-unknown-linux-gnu",
+    "loongarch64-unknown-linux-gnu",
     "x86_64-unknown-linux-gnu",
     "x86_64-unknown-linux-musl",
     "x86_64-pc-windows-msvc",
-- 
2.52.0

