# This file is generated by scripts/update_workflow.py

name: Release
on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:

env:
  RUFF_VERSION: 0.14.6
  RUFF_VSCODE_VERSION: 2025.30.0

jobs:
  build-ruff:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
        # There's currently no loong64 support for Ubuntu so we are using Debian
          - target: loongarch64-unknown-linux-gnu
            arch: loong64
            base_image: --platform=linux/loong64 ghcr.io/loong64/debian:trixie
            maturin_docker_options: -e JEMALLOC_SYS_WITH_LG_PAGE=16
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          submodules: recursive
          persist-credentials: false
          repository: astral-sh/ruff
          ref: ${{ env.RUFF_VERSION }}
      - uses: actions/checkout@v5
        with:
          path: loongcodium-ruff
          sparse-checkout: |
            patches/ruff.patch
          sparse-checkout-cone-mode: false
      - name: Apply patch
        run: |
          git apply loongcodium-ruff/patches/ruff.patch
          rm -rf loongcodium-ruff
      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Prep README.md
        run: python scripts/transform_readme.py --target pypi
      - name: Build wheels
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          manylinux: auto
          docker-options: ${{ matrix.platform.maturin_docker_options }}
          args: --release --locked --out dist
      - uses: uraimo/run-on-arch-action@d94c13912ea685de38fccc1109385b83fd79427d # v3.0.1
        if: ${{ matrix.platform.arch != 'ppc64' && matrix.platform.arch != 'ppc64le'}}
        name: Test wheel
        with:
          arch: ${{ matrix.platform.arch == 'arm' && 'armv6' || matrix.platform.arch }}
          distro: ${{ matrix.platform.arch == 'arm' && 'bullseye' || 'ubuntu20.04' }}
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y --no-install-recommends python3 python3-pip python3-venv libatomic1
          run: |
            python3 -m venv .venv
            source .venv/bin/activate
            pip3 install -U pip
            pip3 install ${{ env.PACKAGE_NAME }} --no-index --find-links dist/ --force-reinstall
            ruff --help
          base_image: ${{ matrix.platform.base_image }}
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: wheels-${{ matrix.platform.target }}
          path: dist
      - name: Archive binary
        shell: bash
        run: |
          set -euo pipefail

          TARGET=${{ matrix.platform.target }}
          ARCHIVE_NAME=ruff-$TARGET
          ARCHIVE_FILE=$ARCHIVE_NAME.tar.gz

          mkdir -p $ARCHIVE_NAME
          cp target/$TARGET/release/ruff $ARCHIVE_NAME/ruff
          tar czvf $ARCHIVE_FILE $ARCHIVE_NAME
          shasum -a 256 $ARCHIVE_FILE > $ARCHIVE_FILE.sha256
      - name: Upload binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: artifacts-${{ matrix.platform.target }}
          path: |
            *.tar.gz
            *.sha256

    env:
      PACKAGE_NAME: ruff
      MODULE_NAME: ruff
      PYTHON_VERSION: '3.13'
      CARGO_INCREMENTAL: 0
      CARGO_NET_RETRY: 10
      CARGO_TERM_COLOR: always
      RUSTUP_MAX_RETRIES: 10

  build-id:
    name: Build ID
    runs-on: ubuntu-latest
    outputs:
      RELEASE_BUILD_ID: ${{ steps.release-build-id-generator.outputs.BUILD_ID }}
      NIGHTLY_BUILD_ID: ${{ steps.nightly-build-id-generator.outputs.BUILD_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: ${{ env.FETCH_DEPTH }}
          persist-credentials: false
          repository: astral-sh/ruff-vscode
          ref: ${{ env.RUFF_VSCODE_VERSION }}
      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: 3.x
      - name: Generate Build ID (release)
        if: startsWith(github.ref, 'refs/tags/')
        id: release-build-id-generator
        run: |
          export BUILD_ID=$(python -m build.generate_build_id)
          echo "BUILD_ID: ${BUILD_ID}"
          echo "BUILD_ID=${BUILD_ID}" >> $GITHUB_OUTPUT
      - name: Generate Build ID (nightly)
        if: "!startsWith(github.ref, 'refs/tags/')"
        id: nightly-build-id-generator
        run: |
          export BUILD_ID=$(python -m build.generate_build_id --pre-release)
          echo "BUILD_ID: ${BUILD_ID}"
          echo "BUILD_ID=${BUILD_ID}" >> $GITHUB_OUTPUT
    env:
      FETCH_DEPTH: 0

  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            target: loongarch64-unknown-linux-gnu
            code-target: linux-loong64
            python-platform: manylinux_2_36_loongarch64

    name: Build (${{ matrix.target }})
    needs: [build-id, build-ruff]
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: ${{ env.FETCH_DEPTH }}
          persist-credentials: false
          repository: astral-sh/ruff-vscode
          ref: ${{ env.RUFF_VSCODE_VERSION }}
      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: 3.x
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6

      - name: Download wheels from previous step
        uses: actions/download-artifact@v5
        with:
          name: wheels-${{ matrix.target }}

      - name: Install libraries
        run: |
          uv pip compile --python-version 3.7.9 --generate-hashes -o ./requirements.txt ./pyproject.toml --no-emit-package ruff
          git diff -- requirements.txt
          python3 -m pip install -t ./bundled/libs --implementation py --no-deps --upgrade -r ./requirements.txt --platform=${{ matrix.python-platform }}
          python3 -m pip install -t ./bundled/libs --implementation py --no-deps --upgrade ruff --no-index --find-links . --platform=${{ matrix.python-platform }}

      - name: Patch metadata
        run: |
          cat package.json | \
          jq '.displayName="Ruff (loong64)"' | \
          jq '.publisher="loong-vsx"' | \
          jq '.homepage="https://github.com/loongcodium/loongcodium-ruff"' | \
          jq '.repository.url="https://github.com/loongcodium/loongcodium-ruff.git"' | \
          jq '.bugs.url="https://github.com/loongcodium/loongcodium-ruff/issues"' \
          > tmp.json && mv -v tmp.json package.json

      - name: Install Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 24

      # Install Node dependencies.
      - run: npm ci

      # Set the Build ID.
      - name: Set Build ID (release)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          python -m build.update_ext_version --build-id "${RELEASE_BUILD_ID}" --for-publishing
        env:
          RELEASE_BUILD_ID: ${{ needs.build-id.outputs.RELEASE_BUILD_ID }}
      - name: Set Build ID (nightly)
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: |
          python -m build.update_ext_version --build-id "${NIGHTLY_BUILD_ID}" --for-publishing --pre-release
        env:
          NIGHTLY_BUILD_ID: ${{ needs.build-id.outputs.NIGHTLY_BUILD_ID }}

      # Build the extension.
      - name: Package Extension (release)
        if: startsWith(github.ref, 'refs/tags/')
        run: npx vsce package -o "./dist/ruff-${{ matrix.code-target }}.vsix"
      - name: Package Extension (nightly)
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: npx vsce package -o "./dist/ruff-${{ matrix.code-target }}.vsix" --pre-release

      # Upload the extension.
      - name: Upload artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: dist-${{ matrix.target }}
          path: ./dist

  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build]
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v5
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            ./**/*.vsix
            ./**/*.whl
            ./**/*.tar.gz
            ./**/*.sha256

      - name: Install ovsx
        run: npm install --global ovsx
      - name: Publish extension
        run: ovsx publish ./**/*.vsix
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
